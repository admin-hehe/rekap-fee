<!DOCTYPE html>
<html lang="id">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Data Kegiatan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'media', 
            theme: {
                extend: {
                    colors: {
                        'primary-active': '#4f46e5',
                    },
                }
            }
        }
    </script>

    <style>
        .table-wrapper {
            overflow-x: auto;
            border-radius: 0.5rem;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            max-height: 90vh; 
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen p-4 md:p-8 transition-colors duration-500">
    <div class="max-w-7xl mx-auto">
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100 text-center mb-6">Rekap Data Kegiatan</h2>
        
        <div class="flex justify-end">
            <button onclick="loadData()" class="mb-4 bg-primary-active hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 dark:bg-primary-active dark:hover:bg-indigo-700">
                üîÑ Refresh Data
            </button>
        </div>
        
        <div id="loading" class="text-center p-4 text-xl font-semibold text-gray-600 dark:text-gray-400">
            Memuat data...
        </div>

        <div class="table-wrapper shadow-xl bg-white dark:bg-gray-800">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700 fixed-header">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">PIC</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Nama Kegiatan</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Kode</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Harga</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Dokumentasi</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Action</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                    </tbody>
            </table>
        </div>
        
        <p id="noData" class="mt-8 text-center text-gray-600 dark:text-gray-400 hidden">
            Tidak ada data yang ditemukan.
        </p>
    </div>

    <div id="docModal" class="modal-overlay">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95 opacity-0 modal-content" id="modalContent">
            <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Input Dokumentasi: <span id="modalRecordId" class="text-primary-active"></span></h3>
            
            <form id="docForm">
                <input type="hidden" id="docRecordId" name="record_id">
                <input type="hidden" name="action" value="uploadDocumentation">

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipe Dokumentasi</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="doc_type" value="text" checked class="form-radio text-primary-active h-4 w-4 dark:bg-gray-700 dark:border-gray-500">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">Link Teks (URL)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="doc_type" value="file" class="form-radio text-primary-active h-4 w-4 dark:bg-gray-700 dark:border-gray-500">
                            <span class="ml-2 text-gray-700 dark:text-gray-300">File Gambar (Dinonaktifkan)</span>
                        </label>
                    </div>
                </div>

                <div id="docTextInput" class="mb-4">
                    <label for="doc_text" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Link Dokumentasi (URL):</label>
                    <input type="url" id="doc_text" name="doc_text" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-md shadow-sm focus:ring-primary-active focus:border-primary-active" required>
                </div>
                
                <div id="docFileInput" class="mb-4 hidden">
                    <label for="doc_file" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pilih File Gambar:</label>
                    <input type="file" id="doc_file" name="doc_file" accept=".jpg,.jpeg,.png,.gif" class="mt-1 block w-full text-sm text-gray-500 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-white dark:bg-gray-700">
                </div>

                <div id="docMessage" class="mt-4 text-center p-3 rounded-lg hidden"></div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideDocModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">
                        Batal
                    </button>
                    <button type="submit" id="docSubmitBtn" class="px-4 py-2 text-sm font-medium text-white bg-primary-active rounded-md hover:bg-indigo-700">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxi78hSKpgQTi_efSulodQpjUYQUDhQokoJsL7d66R9KCRlV8UOCuZB_tLZ6n6GUoW6pw/exec"; 
        
        const dataTableBody = document.getElementById('dataTableBody');
        const loadingIndicator = document.getElementById('loading');
        const noDataMessage = document.getElementById('noData');
        
        const docModal = document.getElementById('docModal');
        const modalContent = document.getElementById('modalContent');
        const docForm = document.getElementById('docForm');
        const docRecordId = document.getElementById('docRecordId');
        const docTextInput = document.getElementById('docTextInput');
        const docFileInput = document.getElementById('docFileInput');
        const docSubmitBtn = document.getElementById('docSubmitBtn');
        const docMessage = document.getElementById('docMessage');
        const modalRecordIdDisplay = document.getElementById('modalRecordId');

        function displayMessage(el, message, isSuccess) {
            el.textContent = message;
            el.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            if (isSuccess) {
                el.classList.add('bg-green-100', 'text-green-800');
            } else {
                el.classList.add('bg-red-100', 'text-red-800');
            }
        }

        function showDocModal(id) {
            modalRecordIdDisplay.textContent = id;
            docRecordId.value = id;
            docModal.classList.add('open');
            modalContent.classList.remove('scale-95', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
            docMessage.classList.add('hidden'); 
            docForm.reset(); 
            document.querySelector('input[name="doc_type"][value="text"]').checked = true;
            toggleDocInput('text');
        }

        function hideDocModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                docModal.classList.remove('open');
            }, 300);
        }
        
        function toggleDocInput(type) {
            const isText = (type === 'text');
            docTextInput.classList.toggle('hidden', !isText);
            docFileInput.classList.toggle('hidden', isText);
            document.getElementById('doc_text').required = isText;
            document.getElementById('doc_file').required = !isText; // Tetap required untuk UX
        }
        
        document.querySelectorAll('input[name="doc_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                toggleDocInput(this.value);
            });
        });

        // --- Fungsi Load Data ---
        async function loadData() {
            loadingIndicator.classList.remove('hidden');
            noDataMessage.classList.add('hidden');
            dataTableBody.innerHTML = '';
            
            try {
                const response = await fetch(`${WEB_APP_URL}?action=getData`, {
                    method: 'GET', mode: 'cors'
                });
                const result = await response.json();

                if (result.result === 'success' && result.data && result.data.length > 0) {
                    
                    result.data.forEach(item => {
                        const row = dataTableBody.insertRow();
                        
                        const cells = [
                            item.id, item.pic, item.nama_kegiatan, item.kode, item.harga,
                        ];
                        
                        cells.forEach((text) => {
                            const cell = row.insertCell();
                            cell.textContent = text;
                            cell.className = `px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300`;
                        });
                        
                        // Kolom Dokumentasi
                        const docCell = row.insertCell();
                        if (item.link_dokumentasi) {
                            docCell.innerHTML = `<a href="${item.link_dokumentasi}" target="_blank" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">Lihat Dokumen</a>`;
                        } else {
                            docCell.textContent = '-';
                        }
                        docCell.className = `px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300`;


                        // Kolom Action
                        const actionCell = row.insertCell();
                        actionCell.innerHTML = `
                            <button onclick="showDocModal('${item.id}')" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded">
                                + Dokumentasi
                            </button>`;
                        actionCell.className = `px-4 py-3 whitespace-nowrap text-center`;
                        
                        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-100';

                    });
                    
                } else {
                    noDataMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error memuat data:', error);
                noDataMessage.textContent = "Gagal memuat data. Cek URL Web App dan koneksi.";
                noDataMessage.classList.remove('hidden');
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- Fungsi Submit Dokumentasi (Dinonaktifkan untuk File) ---
        docForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            docSubmitBtn.disabled = true;
            docSubmitBtn.textContent = 'Menyimpan...';
            docMessage.classList.add('hidden');

            const formData = new FormData(docForm);
            const docType = formData.get('doc_type');
            
            if (docType === 'file') {
                 // FITUR DINONAKTIFKAN DI SINI
                 displayMessage(docMessage, `‚ùå Gagal: Upload file belum diaktifkan. Silakan gunakan opsi Link Teks (URL).`, false);
                 docSubmitBtn.disabled = false;
                 docSubmitBtn.textContent = 'Simpan';
                 docMessage.classList.remove('hidden');
                 return;
            }

            try {
                // Hanya mengirim Link Teks menggunakan fetch POST
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();
                
                if (result.result === 'success') {
                    displayMessage(docMessage, `‚úÖ ${result.message}`, true);
                    
                    setTimeout(() => {
                        hideDocModal();
                        loadData(); 
                    }, 1000);

                } else {
                    displayMessage(docMessage, `‚ùå Gagal: ${result.message}`, false);
                }

            } catch (error) {
                displayMessage(docMessage, `‚ùå Terjadi kesalahan koneksi/server: ${error.toString()}`, false);
            } finally {
                docMessage.classList.remove('hidden');
                docSubmitBtn.disabled = false;
                docSubmitBtn.textContent = 'Simpan';
            }
        });


        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
